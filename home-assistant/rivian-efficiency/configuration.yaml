# Rivian Efficiency Tracking - Configuration (Event-Based Architecture)
# Full Tutorial: https://metrowestsmarthome.com/rivian-home-assistant/
#
# ARCHITECTURE NOTE (2026-01-03):
# This uses SOC-based kWh calculation: kWh = (SOC_delta / 100) × capacity
# This accounts for battery degradation over time.
# Events are fired for accurate 7/30-day queries (no duplicate counting).
# Running totals are used for lifetime stats (survive event purge).
#
# Replace all YOUR_* placeholders with your actual values:
# - YOUR_RIVIAN: Your Rivian entity prefix (e.g., "rivnit" or "rivian_r1t")

# =============================================================================
# INPUT HELPERS - Trip Tracking (SOC-based)
# NOTE: No 'initial:' on start helpers - values must persist through HA restart
# =============================================================================
input_number:
  # SOC-based tracking (captures % and capacity for accurate kWh calculation)
  rivian_trip_start_soc:
    name: "Trip Start SOC"
    min: 0
    max: 100
    step: 0.1
    unit_of_measurement: "%"
    icon: mdi:battery-high

  rivian_trip_start_capacity:
    name: "Trip Start Battery Capacity"
    min: 0
    max: 200
    step: 0.1
    unit_of_measurement: "kWh"
    icon: mdi:battery-check

  rivian_trip_start_odometer:
    name: "Trip Start Odometer"
    min: 0
    max: 500000
    step: 0.1
    unit_of_measurement: "mi"
    icon: mdi:counter

  rivian_trip_start_timestamp:
    name: "Trip Start Timestamp"
    min: 0
    max: 9999999999
    step: 1
    icon: mdi:clock-start

  # Last trip results (for dashboard display)
  rivian_last_trip_efficiency:
    name: "Last Trip Efficiency"
    min: 0
    max: 10
    step: 0.01
    unit_of_measurement: "mi/kWh"
    icon: mdi:gauge

  rivian_last_trip_distance:
    name: "Last Trip Distance"
    min: 0
    max: 1000
    step: 0.1
    unit_of_measurement: "mi"
    icon: mdi:map-marker-distance

  rivian_last_trip_kwh:
    name: "Last Trip kWh Consumed"
    min: 0
    max: 200
    step: 0.1
    unit_of_measurement: "kWh"
    icon: mdi:lightning-bolt

# =============================================================================
# INPUT HELPERS - Temperature Band Running Totals
# These accumulate over time for lifetime stats (events may be purged)
# =============================================================================
  # Cold weather (<32°F)
  rivian_total_miles_cold:
    name: "Total Miles <32°F"
    min: 0
    max: 1000000
    step: 0.01
    unit_of_measurement: "mi"

  rivian_total_kwh_cold:
    name: "Total kWh <32°F"
    min: 0
    max: 500000
    step: 0.01
    unit_of_measurement: "kWh"

  # Cool weather (32-50°F)
  rivian_total_miles_cool:
    name: "Total Miles 32-50°F"
    min: 0
    max: 1000000
    step: 0.01
    unit_of_measurement: "mi"

  rivian_total_kwh_cool:
    name: "Total kWh 32-50°F"
    min: 0
    max: 500000
    step: 0.01
    unit_of_measurement: "kWh"

  # Mild weather (50-70°F)
  rivian_total_miles_mild:
    name: "Total Miles 50-70°F"
    min: 0
    max: 1000000
    step: 0.01
    unit_of_measurement: "mi"

  rivian_total_kwh_mild:
    name: "Total kWh 50-70°F"
    min: 0
    max: 500000
    step: 0.01
    unit_of_measurement: "kWh"

  # Warm weather (>70°F)
  rivian_total_miles_warm:
    name: "Total Miles >70°F"
    min: 0
    max: 1000000
    step: 0.01
    unit_of_measurement: "mi"

  rivian_total_kwh_warm:
    name: "Total kWh >70°F"
    min: 0
    max: 500000
    step: 0.01
    unit_of_measurement: "kWh"

# =============================================================================
# INPUT HELPERS - Temperature Band Baselines
# These DO use initial: as configuration defaults
# =============================================================================
  rivian_baseline_cold:
    name: "Baseline Efficiency <32°F"
    min: 0
    max: 5
    step: 0.01
    initial: 2.0
    unit_of_measurement: "mi/kWh"
    icon: mdi:snowflake

  rivian_baseline_cool:
    name: "Baseline Efficiency 32-50°F"
    min: 0
    max: 5
    step: 0.01
    initial: 2.2
    unit_of_measurement: "mi/kWh"
    icon: mdi:thermometer-low

  rivian_baseline_mild:
    name: "Baseline Efficiency 50-70°F"
    min: 0
    max: 5
    step: 0.01
    initial: 2.4
    unit_of_measurement: "mi/kWh"
    icon: mdi:thermometer

  rivian_baseline_warm:
    name: "Baseline Efficiency >70°F"
    min: 0
    max: 5
    step: 0.01
    initial: 2.5
    unit_of_measurement: "mi/kWh"
    icon: mdi:thermometer-high

# =============================================================================
# INPUT HELPERS - Idle Drain Tracking (SOC-based)
# =============================================================================
  rivian_idle_start_soc:
    name: "Idle Start SOC"
    min: 0
    max: 100
    step: 0.1
    unit_of_measurement: "%"
    icon: mdi:battery-high

  rivian_idle_start_capacity:
    name: "Idle Start Battery Capacity"
    min: 0
    max: 200
    step: 0.1
    unit_of_measurement: "kWh"
    icon: mdi:battery-check

  rivian_idle_start_timestamp:
    name: "Idle Start Timestamp"
    min: 0
    max: 9999999999
    step: 1
    icon: mdi:clock-start

  rivian_last_idle_drain_rate:
    name: "Last Idle Drain Rate"
    min: 0
    max: 10
    step: 0.001
    unit_of_measurement: "kWh/hr"
    icon: mdi:battery-minus

  rivian_last_idle_hours:
    name: "Last Idle Duration"
    min: 0
    max: 720
    step: 0.1
    unit_of_measurement: "hr"
    icon: mdi:timer

# =============================================================================
# INPUT BOOLEANS - In-Progress Flags
# NO initial: - must persist through HA restarts
# =============================================================================
input_boolean:
  rivian_trip_in_progress:
    name: "Trip In Progress"
    icon: mdi:car

  rivian_idle_in_progress:
    name: "Idle Session In Progress"
    icon: mdi:sleep

  rivian_charge_in_progress:
    name: "Charging In Progress"
    icon: mdi:ev-station

# =============================================================================
# SQL SENSORS - Event-Based Queries
# These query the events table for accurate 7/30-day totals (no duplicates)
# =============================================================================
sql:
  # 7-day trip totals (from events)
  - name: "Rivian Cumulative Miles 7d"
    query: >
      SELECT COALESCE(SUM(CAST(json_extract(e.event_data, '$.distance') AS FLOAT)), 0) as total
      FROM events e
      INNER JOIN event_types et ON e.event_type_id = et.event_type_id
      WHERE et.event_type = 'rivian_trip_completed'
        AND e.time_fired_ts >= (strftime('%s', 'now') - 7*24*60*60)
    column: 'total'
    unit_of_measurement: 'mi'
    db_url: sqlite:////config/home-assistant_v2.db

  - name: "Rivian Cumulative kWh 7d"
    query: >
      SELECT COALESCE(SUM(CAST(json_extract(e.event_data, '$.kwh_used') AS FLOAT)), 0) as total
      FROM events e
      INNER JOIN event_types et ON e.event_type_id = et.event_type_id
      WHERE et.event_type = 'rivian_trip_completed'
        AND e.time_fired_ts >= (strftime('%s', 'now') - 7*24*60*60)
    column: 'total'
    unit_of_measurement: 'kWh'
    db_url: sqlite:////config/home-assistant_v2.db

  # 30-day trip totals (from events)
  - name: "Rivian Cumulative Miles 30d"
    query: >
      SELECT COALESCE(SUM(CAST(json_extract(e.event_data, '$.distance') AS FLOAT)), 0) as total
      FROM events e
      INNER JOIN event_types et ON e.event_type_id = et.event_type_id
      WHERE et.event_type = 'rivian_trip_completed'
        AND e.time_fired_ts >= (strftime('%s', 'now') - 30*24*60*60)
    column: 'total'
    unit_of_measurement: 'mi'
    db_url: sqlite:////config/home-assistant_v2.db

  - name: "Rivian Cumulative kWh 30d"
    query: >
      SELECT COALESCE(SUM(CAST(json_extract(e.event_data, '$.kwh_used') AS FLOAT)), 0) as total
      FROM events e
      INNER JOIN event_types et ON e.event_type_id = et.event_type_id
      WHERE et.event_type = 'rivian_trip_completed'
        AND e.time_fired_ts >= (strftime('%s', 'now') - 30*24*60*60)
    column: 'total'
    unit_of_measurement: 'kWh'
    db_url: sqlite:////config/home-assistant_v2.db

# =============================================================================
# TEMPLATE SENSORS - Display Values
# =============================================================================
template:
  - sensor:
      - name: "Rivian Efficiency Last Trip"
        unique_id: rivian_efficiency_last_trip
        unit_of_measurement: "mi/kWh"
        state_class: measurement
        state: "{{ states('input_number.rivian_last_trip_efficiency') | float(0) | round(2) }}"
        availability: "{{ states('input_number.rivian_last_trip_efficiency') | float(0) > 0 }}"
        icon: mdi:speedometer
        attributes:
          last_trip_distance: "{{ states('input_number.rivian_last_trip_distance') | float(0) | round(2) }} mi"
          last_trip_kwh: "{{ states('input_number.rivian_last_trip_kwh') | float(0) | round(2) }} kWh"

      # 7-day mile-weighted average (from SQL event queries)
      - name: "Rivian Efficiency 7d"
        unique_id: rivian_efficiency_7d
        unit_of_measurement: "mi/kWh"
        state_class: measurement
        state: >
          {% set miles = states('sensor.rivian_cumulative_miles_7d') | float(0) %}
          {% set kwh = states('sensor.rivian_cumulative_kwh_7d') | float(0) %}
          {{ (miles / kwh) | round(2) if kwh > 0 else 0 }}
        availability: "{{ states('sensor.rivian_cumulative_kwh_7d') | float(0) > 0 }}"
        icon: mdi:calculator

      # 30-day mile-weighted average (from SQL event queries)
      - name: "Rivian Efficiency 30d"
        unique_id: rivian_efficiency_30d
        unit_of_measurement: "mi/kWh"
        state_class: measurement
        state: >
          {% set miles = states('sensor.rivian_cumulative_miles_30d') | float(0) %}
          {% set kwh = states('sensor.rivian_cumulative_kwh_30d') | float(0) %}
          {{ (miles / kwh) | round(2) if kwh > 0 else 0 }}
        availability: "{{ states('sensor.rivian_cumulative_kwh_30d') | float(0) > 0 }}"
        icon: mdi:calculator

      # Lifetime efficiency (from running totals - survives event purge)
      - name: "Rivian Efficiency Lifetime"
        unique_id: rivian_efficiency_lifetime
        unit_of_measurement: "mi/kWh"
        state_class: measurement
        state: >
          {% set miles = states('input_number.rivian_total_miles_cold') | float(0) +
                         states('input_number.rivian_total_miles_cool') | float(0) +
                         states('input_number.rivian_total_miles_mild') | float(0) +
                         states('input_number.rivian_total_miles_warm') | float(0) %}
          {% set kwh = states('input_number.rivian_total_kwh_cold') | float(0) +
                       states('input_number.rivian_total_kwh_cool') | float(0) +
                       states('input_number.rivian_total_kwh_mild') | float(0) +
                       states('input_number.rivian_total_kwh_warm') | float(0) %}
          {{ (miles / kwh) | round(2) if kwh > 0 else 0 }}
        icon: mdi:chart-timeline-variant

      - name: "Rivian Idle Drain Last"
        unique_id: rivian_idle_drain_last
        unit_of_measurement: "kWh/hr"
        state_class: measurement
        state: "{{ states('input_number.rivian_last_idle_drain_rate') | float(0) | round(3) }}"
        availability: "{{ states('input_number.rivian_last_idle_hours') | float(0) > 0 }}"
        icon: mdi:battery-minus
        attributes:
          last_idle_duration: "{{ states('input_number.rivian_last_idle_hours') | float(0) | round(1) }} hr"

      # Temperature-adjusted baseline (selects appropriate baseline for current temp)
      - name: "Rivian Temperature Adjusted Baseline"
        unique_id: rivian_temp_adjusted_baseline
        unit_of_measurement: "mi/kWh"
        state: >
          {% set temp = states('sensor.YOUR_RIVIAN_outside_temperature') | float(50) %}
          {% if temp < 32 %}
            {{ states('input_number.rivian_baseline_cold') | float(2.0) | round(2) }}
          {% elif temp < 50 %}
            {{ states('input_number.rivian_baseline_cool') | float(2.2) | round(2) }}
          {% elif temp < 70 %}
            {{ states('input_number.rivian_baseline_mild') | float(2.4) | round(2) }}
          {% else %}
            {{ states('input_number.rivian_baseline_warm') | float(2.5) | round(2) }}
          {% endif %}
        icon: mdi:gauge
