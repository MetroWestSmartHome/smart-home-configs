# Rivian Efficiency Tracking - Automations (Event-Based Architecture)
# Full Tutorial: https://metrowestsmarthome.com/rivian-home-assistant/
#
# ARCHITECTURE NOTE (2026-01-03):
# This uses EVENT-BASED logging instead of querying input_number state history.
# Events are immutable - they fire once per trip/idle/charge session.
# SQL sensors query the events table for accurate 7/30-day stats.
# Running totals are used for lifetime stats (survive event purge).
#
# Replace all YOUR_* placeholders with your actual values:
# - YOUR_RIVIAN: Your Rivian entity prefix (e.g., "rivnit" or "rivian_r1t")
# - YOUR_CHARGER: Your EV charger entity prefix (e.g., "tesla_wall_connector")

# =============================================================================
# TRIP TRACKING - Start
# Records SOC and battery capacity when driving begins
# Uses SOC-based calculation: kWh = (SOC_delta / 100) Ã— capacity
# =============================================================================
- id: rivian_trip_start
  alias: 'RIVIAN: Trip Start'
  description: Capture SOC, capacity, and odometer when driving begins
  trigger:
  - platform: state
    entity_id: sensor.YOUR_RIVIAN_power_state
    to: Go
  condition:
  - condition: state
    entity_id: sensor.YOUR_RIVIAN_service_mode
    state: 'off'
  # Prevent re-triggering after HA restart if trip already in progress
  - condition: state
    entity_id: input_boolean.rivian_trip_in_progress
    state: 'off'
  action:
  # Mark trip as in progress FIRST (survives restart)
  - service: input_boolean.turn_on
    entity_id: input_boolean.rivian_trip_in_progress
  # Store SOC and capacity for accurate kWh calculation
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_trip_start_soc
    data:
      value: '{{ states(''sensor.YOUR_RIVIAN_battery_state_of_charge'') | float(0) }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_trip_start_capacity
    data:
      value: '{{ states(''sensor.YOUR_RIVIAN_battery_capacity'') | float(122) }}'
  # Store odometer and timestamp
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_trip_start_odometer
    data:
      value: '{{ states(''sensor.YOUR_RIVIAN_odometer'') | float(0) }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_trip_start_timestamp
    data:
      value: '{{ as_timestamp(now()) }}'
  mode: single

# =============================================================================
# TRIP TRACKING - End
# Calculates efficiency using SOC-based kWh, fires event, updates running totals
# =============================================================================
- id: rivian_trip_end
  alias: 'RIVIAN: Trip End'
  description: Calculate efficiency, fire event for accurate queries, update running totals
  trigger:
  - platform: state
    entity_id: sensor.YOUR_RIVIAN_power_state
    from: Go
    for:
      seconds: 30
  condition:
  - condition: state
    entity_id: sensor.YOUR_RIVIAN_service_mode
    state: 'off'
  # Prevent spurious triggers on HA restart - only end a trip that was started
  - condition: state
    entity_id: input_boolean.rivian_trip_in_progress
    state: 'on'
  action:
  # Clear in-progress flag FIRST (even if calculations fail)
  - service: input_boolean.turn_off
    entity_id: input_boolean.rivian_trip_in_progress
  - variables:
      # SOC-based kWh calculation
      start_soc: '{{ states(''input_number.rivian_trip_start_soc'') | float(0) }}'
      end_soc: '{{ states(''sensor.YOUR_RIVIAN_battery_state_of_charge'') | float(0) }}'
      capacity: '{{ states(''input_number.rivian_trip_start_capacity'') | float(122) }}'
      soc_used: '{{ start_soc - end_soc }}'
      kwh_used: '{{ (soc_used / 100) * capacity }}'
      # Distance
      start_odo: '{{ states(''input_number.rivian_trip_start_odometer'') | float(0) }}'
      end_odo: '{{ states(''sensor.YOUR_RIVIAN_odometer'') | float(0) }}'
      distance: '{{ end_odo - start_odo }}'
      # Efficiency
      efficiency: '{{ (distance / kwh_used) | round(2) if kwh_used > 0 else 0 }}'
      # Temperature band
      temp: '{{ states(''sensor.YOUR_RIVIAN_outside_temperature'') | float(50) }}'
      temp_band: >
        {% if temp < 32 %}cold
        {% elif temp < 50 %}cool
        {% elif temp < 70 %}mild
        {% else %}warm{% endif %}
  # Only process meaningful trips (>0.5 miles, consumed energy)
  - condition: template
    value_template: '{{ distance >= 0.5 and kwh_used > 0 }}'
  # Store last trip values for dashboard display
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_last_trip_distance
    data:
      value: '{{ distance | round(2) }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_last_trip_kwh
    data:
      value: '{{ kwh_used | round(2) }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_last_trip_efficiency
    data:
      value: '{{ efficiency }}'
  # FIRE EVENT for accurate 7/30-day queries (immutable, no restart duplicates)
  - event: rivian_trip_completed
    event_data:
      distance: '{{ distance | round(2) }}'
      kwh_used: '{{ kwh_used | round(2) }}'
      efficiency: '{{ efficiency }}'
      soc_used: '{{ soc_used | round(1) }}'
      battery_capacity: '{{ capacity | round(1) }}'
      temp_band: '{{ temp_band }}'
      outside_temp: '{{ temp | round(0) }}'
      timestamp: '{{ now().isoformat() }}'
  # Update running totals for temperature band (for lifetime stats after events purge)
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ temp_band == ''cold'' }}'
      sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_miles_cold
        data:
          value: '{{ states(''input_number.rivian_total_miles_cold'') | float(0) + distance }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_kwh_cold
        data:
          value: '{{ states(''input_number.rivian_total_kwh_cold'') | float(0) + kwh_used }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_baseline_cold
        data:
          value: >
            {% set new_miles = states('input_number.rivian_total_miles_cold') | float(0) + distance %}
            {% set new_kwh = states('input_number.rivian_total_kwh_cold') | float(0) + kwh_used %}
            {{ (new_miles / new_kwh) | round(2) if new_kwh > 0 else 2.0 }}
    - conditions:
      - condition: template
        value_template: '{{ temp_band == ''cool'' }}'
      sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_miles_cool
        data:
          value: '{{ states(''input_number.rivian_total_miles_cool'') | float(0) + distance }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_kwh_cool
        data:
          value: '{{ states(''input_number.rivian_total_kwh_cool'') | float(0) + kwh_used }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_baseline_cool
        data:
          value: >
            {% set new_miles = states('input_number.rivian_total_miles_cool') | float(0) + distance %}
            {% set new_kwh = states('input_number.rivian_total_kwh_cool') | float(0) + kwh_used %}
            {{ (new_miles / new_kwh) | round(2) if new_kwh > 0 else 2.2 }}
    - conditions:
      - condition: template
        value_template: '{{ temp_band == ''mild'' }}'
      sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_miles_mild
        data:
          value: '{{ states(''input_number.rivian_total_miles_mild'') | float(0) + distance }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_kwh_mild
        data:
          value: '{{ states(''input_number.rivian_total_kwh_mild'') | float(0) + kwh_used }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_baseline_mild
        data:
          value: >
            {% set new_miles = states('input_number.rivian_total_miles_mild') | float(0) + distance %}
            {% set new_kwh = states('input_number.rivian_total_kwh_mild') | float(0) + kwh_used %}
            {{ (new_miles / new_kwh) | round(2) if new_kwh > 0 else 2.4 }}
    - conditions:
      - condition: template
        value_template: '{{ temp_band == ''warm'' }}'
      sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_miles_warm
        data:
          value: '{{ states(''input_number.rivian_total_miles_warm'') | float(0) + distance }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_total_kwh_warm
        data:
          value: '{{ states(''input_number.rivian_total_kwh_warm'') | float(0) + kwh_used }}'
      - service: input_number.set_value
        target:
          entity_id: input_number.rivian_baseline_warm
        data:
          value: >
            {% set new_miles = states('input_number.rivian_total_miles_warm') | float(0) + distance %}
            {% set new_kwh = states('input_number.rivian_total_kwh_warm') | float(0) + kwh_used %}
            {{ (new_miles / new_kwh) | round(2) if new_kwh > 0 else 2.5 }}
  mode: single

# =============================================================================
# IDLE DRAIN TRACKING - Start
# Records SOC and capacity when vehicle stops driving
# =============================================================================
- id: rivian_idle_start
  alias: 'RIVIAN: Idle Drain Start'
  description: Capture SOC and capacity when vehicle stops driving
  trigger:
  - platform: state
    entity_id: sensor.YOUR_RIVIAN_power_state
    from: Go
    for:
      minutes: 5
  condition:
  - condition: state
    entity_id: sensor.YOUR_RIVIAN_service_mode
    state: 'off'
  - condition: state
    entity_id: binary_sensor.YOUR_RIVIAN_charging_status
    state: 'off'
  - condition: state
    entity_id: input_boolean.rivian_idle_in_progress
    state: 'off'
  action:
  - service: input_boolean.turn_on
    entity_id: input_boolean.rivian_idle_in_progress
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_idle_start_soc
    data:
      value: '{{ states(''sensor.YOUR_RIVIAN_battery_state_of_charge'') | float(0) }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_idle_start_capacity
    data:
      value: '{{ states(''sensor.YOUR_RIVIAN_battery_capacity'') | float(122) }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.rivian_idle_start_timestamp
    data:
      value: '{{ as_timestamp(now()) }}'
  mode: single

# =============================================================================
# IDLE DRAIN TRACKING - End
# Calculates drain using SOC-based kWh, fires event
# =============================================================================
- id: rivian_idle_end
  alias: 'RIVIAN: Idle Drain End'
  description: Calculate drain, fire event for accurate queries, update running totals
  trigger:
  - platform: state
    entity_id: sensor.YOUR_RIVIAN_power_state
    to: Go
  - platform: state
    entity_id: binary_sensor.YOUR_RIVIAN_charging_status
    to: 'on'
  condition:
  - condition: state
    entity_id: sensor.YOUR_RIVIAN_service_mode
    state: 'off'
  - condition: state
    entity_id: input_boolean.rivian_idle_in_progress
    state: 'on'
  action:
  - service: input_boolean.turn_off
    entity_id: input_boolean.rivian_idle_in_progress
  - variables:
      start_soc: '{{ states(''input_number.rivian_idle_start_soc'') | float(0) }}'
      end_soc: '{{ states(''sensor.YOUR_RIVIAN_battery_state_of_charge'') | float(0) }}'
      capacity: '{{ states(''input_number.rivian_idle_start_capacity'') | float(122) }}'
      start_time: '{{ states(''input_number.rivian_idle_start_timestamp'') | float(0) }}'
      now_time: '{{ as_timestamp(now()) }}'
      soc_lost: '{{ [start_soc - end_soc, 0] | max }}'
      kwh_lost: '{{ (soc_lost / 100) * capacity }}'
      hours_idle: '{{ (now_time - start_time) / 3600 }}'
      drain_rate: '{{ (kwh_lost / hours_idle) | round(3) if hours_idle > 0 else 0 }}'
      temp: '{{ states(''sensor.YOUR_RIVIAN_outside_temperature'') | float(50) }}'
      temp_band: >
        {% if temp < 32 %}cold
        {% elif temp < 50 %}cool
        {% elif temp < 70 %}mild
        {% else %}warm{% endif %}
  - if:
    - condition: template
      value_template: '{{ hours_idle > 1 or kwh_lost > 0 }}'
    then:
    - service: input_number.set_value
      target:
        entity_id: input_number.rivian_last_idle_hours
      data:
        value: '{{ hours_idle | round(1) }}'
    - service: input_number.set_value
      target:
        entity_id: input_number.rivian_last_idle_drain_rate
      data:
        value: '{{ drain_rate }}'
    # Fire event for accurate 7/30-day queries
    - event: rivian_idle_completed
      event_data:
        kwh_lost: '{{ kwh_lost | round(2) }}'
        hours_idle: '{{ hours_idle | round(2) }}'
        drain_rate: '{{ drain_rate }}'
        soc_lost: '{{ soc_lost | round(1) }}'
        battery_capacity: '{{ capacity | round(1) }}'
        temp_band: '{{ temp_band }}'
        outside_temp: '{{ temp | round(0) }}'
        timestamp: '{{ now().isoformat() }}'
  mode: single

# =============================================================================
# HA RESTART RECOVERY
# Resets orphaned or stale in-progress flags after Home Assistant restarts
# =============================================================================
- id: rivian_restart_recovery
  alias: 'RIVIAN: Restart Recovery'
  description: Reset orphaned or stale in-progress flags after HA restart
  trigger:
  - platform: homeassistant
    event: start
  action:
  - delay:
      seconds: 60
  - if:
    - condition: state
      entity_id: input_boolean.rivian_trip_in_progress
      state: 'on'
    - condition: template
      value_template: "{{ states('sensor.YOUR_RIVIAN_power_state') != 'Go' }}"
    then:
    - service: input_boolean.turn_off
      entity_id: input_boolean.rivian_trip_in_progress
    - service: logbook.log
      data:
        name: "Rivian Tracking"
        message: "Trip tracking reset after restart - data from interrupted trip was lost"
  - if:
    - condition: state
      entity_id: input_boolean.rivian_idle_in_progress
      state: 'on'
    - condition: state
      entity_id: sensor.YOUR_RIVIAN_power_state
      state: 'Go'
    then:
    - service: input_boolean.turn_off
      entity_id: input_boolean.rivian_idle_in_progress
    - service: logbook.log
      data:
        name: "Rivian Tracking"
        message: "Idle tracking reset after restart"
  mode: single
